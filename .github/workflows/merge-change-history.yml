name: merge-change-history

on:
  push:
    paths:
      - "**/CHANGELOG.md" # æ›´æ–°æ—¥å¿—
  workflow_dispatch:

jobs:
  run-python:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.QWY_SYNC_BOT_TOKEN }}
          repository: ChinaGodMan/UserScripts
          fetch-depth: 0 #æ£€æŸ¥æ—¶é—´ç”¨.

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install markdown
          pip install beautifulsoup4

      - name: æ£€æŸ¥æ–°è„šæœ¬
        run: |
          python utils/script-import-sync.py
        env:
          GFU: ${{ secrets.GFU }}
          GFP: ${{ secrets.GFP }}

      - name: ç›¸å…³è„šæœ¬
        run: |
          python utils/update_related_scripts.py

      - name: å¯¼èˆªæ 
        run: |
          python utils/navigation.py

      - name: å¾½ç« ä¿¡æ¯
        run: |
          python utils/update_shields.py

      - name: å¸®åŠ©ä¿¡æ¯
        run: |
          python utils/update_help.py

      - name: æ‰€æœ‰è„šæœ¬
        run: |
          python utils/update_related_all_scripts.py

      - name: å˜æ›´æ—¥å¿—
        run: |
          python utils/merge_change_history.py
      - name: è®¾ç½®æœºå™¨äººæäº¤
        run: |
          gpg --batch --import <(echo "${{ secrets.GPG_PRIVATE_KEY }}")
          git config --global commit.gpgsign true
          git config --global user.name 'ChinaGodBot'
          git config --global user.email "${{ secrets.GPG_PRIVATE_EMAIL }}"
          git config --global user.signingkey "${{ secrets.GPG_PRIVATE_ID }}"
      - name: æäº¤å’Œæ¨é€æ›´æ”¹
        run: |
          git pull
          git add .
          git commit -n -m "docs(ci): ğŸ“ æ›´æ–°[\`è„šæœ¬è‡ªè¿°==>README_[lang].md\`]" \
                      -m "åˆå¹¶æ—¥å¿—:/Change history/README.md â†’ README_[lang].md" \
                      -m "åˆ·æ–°å¾½ç« :utils/docs/SHIELDS.md â†’ README_[lang].md" \
                      -m "åˆ·æ–°å¸®åŠ©:utils/docs/HELP.md â†’ README_[lang].md" \
                      -m "ç›¸å…³è„šæœ¬:docs/ScriptsPath.json[script.relatedscripts] â†’ README_[lang].md" \
                      -m "æ‰€æœ‰è„šæœ¬:docs/ScriptsPath.json[script.relatedscripts] â†’ README_[lang].md" \
                      -m "è¯­è¨€å¯¼èˆª: â†’ README_[lang].md" \
          || true
          git push
          if [ $? -ne 0 ]; then
            git pull --rebase
            git push
          fi
