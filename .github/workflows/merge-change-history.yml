name: merge-change-history

on:
  push:
    paths:
      - "**/Change history/README.md" # å¢åŠ äº†æ–°å†å²è¯´æ˜
      #- 'docs/ScriptsPath.json'  # ä¹Ÿåœ¨ docs/ScriptsPath.json æ–‡ä»¶å‘ç”Ÿå˜åŠ¨æ—¶è§¦å‘ ä¿®æ”¹äº†æ–°è¯´æ˜.
  workflow_dispatch:

concurrency:
  group: update-qinwuyuan-UserScripts
  cancel-in-progress: false

jobs:
  run-python:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install markdown
          pip install beautifulsoup4

      - name: æ£€æŸ¥æ–°è„šæœ¬
        run: |
          python utils/script-import-sync.py
        env:
          GFU: ${{ secrets.GFU }}
          GFP: ${{ secrets.GFP }}

      - name: ç›¸å…³è„šæœ¬
        run: |
          python utils/update_related_scripts.py

      - name: å¯¼èˆªæ 
        run: |
          python utils/navigation.py

      - name: å¾½ç« ä¿¡æ¯
        run: |
          python utils/update_shields.py

      - name: å¸®åŠ©ä¿¡æ¯
        run: |
          python utils/update_help.py

      - name: æ‰€æœ‰è„šæœ¬
        run: |
          python utils/update_related_all_scripts.py

      - name: å˜æ›´æ—¥å¿—
        run: |
          python utils/merge_change_history.py

      - name: æäº¤å’Œæ¨é€æ›´æ”¹
        run: |
          gpg --batch --import <(echo "${{ secrets.GPG_PRIVATE_KEY }}")
          git config --global user.name 'qinwuyuan-sync-bot'
          git config --global user.email "${{ secrets.GPG_PRIVATE_EMAIL }}"
          git config --global user.signingkey "${{ secrets.GPG_PRIVATE_ID }}"
          git pull
          git add .
          git commit -n -S -m "docs(ci): ğŸ“ æ›´æ–°[\`è„šæœ¬è‡ªè¿°\`]" \
                      -m "åˆå¹¶æ—¥å¿—:Change history/README.md â†’ **/*.md" \
                      -m "åˆ·æ–°å¾½ç« :SHIELDS.md â†’ **/*.md" \
                      -m "åˆ·æ–°å¸®åŠ©:HELP.md â†’ **/*.md" \
                      -m "ç›¸å…³è„šæœ¬:ScriptsPath.json[script.relatedscripts] â†’ **/*.md" \
                      -m "æ‰€æœ‰è„šæœ¬:ScriptsPath.json[script.relatedscripts] â†’ **/*.md" \
                      -m "è¯­è¨€å¯¼èˆª:**/*.md â†’ xx|xx" \
          || echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          git push
