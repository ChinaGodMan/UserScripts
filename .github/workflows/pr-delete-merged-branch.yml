name: delete-merged-branch
on:
  pull_request:
    types:
      - closed

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code ğŸ‘‹
        uses: actions/checkout@v5
      - name: Delete merged branch â›™
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.QWY_SYNC_BOT_TOKEN }}
          script: |
            const { repo: { owner, repo } } = context;
            const pr = context.payload.pull_request;
            // è·³è¿‡ Dependabot æäº¤çš„ PR,å› ä¸ºè¿™äº›PRä¼šè¢«å…¶ä»–æµç¨‹(dependabot.yml)åˆ é™¤
            if (pr.user.login === 'dependabot[bot]') {
              console.log('æ˜¯ Dependabot æäº¤çš„ PRï¼Œè·³è¿‡å¤„ç†');
              return;
            }
            if (!pr.merged) {
              console.log('PR æœªåˆå¹¶ï¼Œä¸åˆ é™¤åˆ†æ”¯');
              return;
            }

            const branch = pr.head.ref;
            console.log(`PR å·²åˆå¹¶ï¼Œæ­£åœ¨åˆ é™¤åˆ†æ”¯: ${branch}`);
            await github.rest.git.deleteRef({
              owner,
              repo,
              ref: `heads/${branch}`,
            });
