name: Auto Merge
on:
  pull_request_target:
    types:
      - opened
      - synchronize

jobs:
  check:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    steps:
      - name: Checkout code ğŸ‘‹
        uses: actions/checkout@v5

      - name: Check and merge â›™
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.QWY_SYNC_BOT_TOKEN }}
          script: |
            const { repo: { owner, repo } } = context;
            const pr = context.payload.pull_request;

            // 1. ä»…å¤„ç† Dependabot æäº¤çš„ PR
            if (pr.user.login !== 'dependabot[bot]') {
              console.log('ä¸æ˜¯ Dependabot æäº¤çš„ PRï¼Œè·³è¿‡å¤„ç†');
              return;
            }

            // 2. å°è¯•åˆå¹¶ PR
            try {
              console.log(`å°è¯•åˆå¹¶ PR: ${pr.html_url}`);
              const commitTitle= `${pr.title} (#${pr.number})`;
              const commitMessage = "Signed-off-by: dependabot[bot] <support@github.com>";
              console.log(`æäº¤ä¿¡æ¯: ${commitTitle}`);
              //æ‰¹å‡†PR
              await github.rest.pulls.createReview({
                owner,
                repo,
                pull_number: pr.number,
                event: 'APPROVE'
                });

              // åˆå¹¶PR
              await github.rest.pulls.merge({
                owner,
                repo,
                pull_number: pr.number,
                merge_method: "squash",  // æŒ¤å‹åˆå¹¶
                commit_title: commitTitle,
                commit_message: commitMessage,
              });

              // åˆ é™¤åˆ†æ”¯
              console.log(`PR åˆå¹¶æˆåŠŸï¼Œåˆ é™¤åˆ†æ”¯: ${pr.head.ref}`);
              await github.rest.git.deleteRef({
                owner,
                repo,
                ref: `heads/${pr.head.ref}`,
              });

            } catch (error) {
              // 3. åˆå¹¶å¤±è´¥æ—¶ï¼Œå¯èƒ½å­˜åœ¨å†²çª.é‡æ–°å…³é—­å’Œæ‰“å¼€PR,è®©Dependabotå¤„ç†å†²çª.
              console.log(`åˆå¹¶å¤±è´¥: ${error.message}`);

              // æ£€æŸ¥ PR æ˜¯å¦å·²æœ‰ "MERGE-FAILED" æ ‡ç­¾
              const labels = await github.rest.issues.listLabelsOnIssue({
                owner,
                repo,
                issue_number: pr.number,
              });

              const hasMergeFailedLabel = labels.data.some(label => label.name === "MERGE-FAILED");

              if (hasMergeFailedLabel) {
                console.log(`PR å·²ç»æœ‰ "MERGE-FAILED" æ ‡ç­¾ï¼Œè·³è¿‡è¿›ä¸€æ­¥æ“ä½œ`);
                return;
              }

              // å¦‚æœæ²¡æœ‰æ ‡ç­¾ï¼Œåˆ™æ·»åŠ  "MERGE-FAILED" æ ‡ç­¾
              console.log(`æ·»åŠ  "MERGE-FAILED" æ ‡ç­¾åˆ° PR: ${pr.html_url}`);
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: pr.number,
                labels: ["MERGE-FAILED"],
              });

              // å…³é—­ PR
              console.log(`å…³é—­ PR: ${pr.html_url}`);
              await github.rest.pulls.update({
                owner,
                repo,
                pull_number: pr.number,
                state: 'closed',
              });

              // é‡æ–°æ‰“å¼€ PR
              console.log(`é‡æ–°æ‰“å¼€ PR: ${pr.html_url}`);
              await github.rest.pulls.update({
                owner,
                repo,
                pull_number: pr.number,
                state: 'open',
              });
            }
