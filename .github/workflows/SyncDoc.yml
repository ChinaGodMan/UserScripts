name: Sync Readme Files

on:
  push:
    paths:
      - "**/CHANGELOG.md" # è„šæœ¬æ›´æ–°æ—¥å¿—
      - "**/README.md" # è„šæœ¬ä»‹ç»æ–‡ä»¶
      - "docs/ScriptsPath.json" # è„šæœ¬åˆ—è¡¨
  workflow_dispatch:

jobs:
  run-python:
    if: ${{ github.event.commits[0].committer.username != 'ChinaGodBot' }}
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.QWY_SYNC_BOT_TOKEN }}
          fetch-depth: 0 #æ£€æŸ¥æ—¶é—´ç”¨.

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v5
        with:
          node-version: "20.18.0"

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5.6.0
        with:
          python-version: "3.12.4"

      - name: pip
        run: pip install -r utils/requirements.txt

      - name: npm
        run: npm install

      - name: æ£€æŸ¥æ–°è„šæœ¬
        run: python utils/script-import-sync.py
        env:
          GFU: ${{ secrets.GFU }}
          GFP: ${{ secrets.GFP }}
          GREASYFORK_TOTP_SECRET: ${{ secrets.GREASYFORK_TOTP_SECRET }}

      #- name: ç›¸å…³è„šæœ¬
      #  run: python utils/update_related_scripts.py
      #- name: æ‰€æœ‰è„šæœ¬
      #  run: python utils/update_related_all_scripts.py

      - name: å¯¼èˆªæ 
        run: python utils/navigation.py

      - name: å˜æ›´æ—¥å¿—
        run: python utils/merge_change_history.py

      - name: åˆ·æ–°ä»“åº“è‡ªè¿°ä¸­çš„è„šæœ¬åˆ—è¡¨
        run: python utils/update_scripts_list.py

      - name: ç¿»è¯‘ä»“åº“è‡ªè¿°
        run: python utils/translate_force_chinese_to_lang.py

      - name: ä¿®å¤å…¶ä»–è¯­è¨€readmeä¸­çš„ç›¸å¯¹è·¯å¾„
        run: python utils/fix_toc.py

      # `å¾½ç« ä¿¡æ¯` `å¸®åŠ©ä¿¡æ¯`  éœ€è¦ä»ä¿®å¤tocä¹‹åæå–è„šæœ¬åˆ—è¡¨æ ‡è®°ç‚¹.
      - name: å¾½ç« ä¿¡æ¯
        run: python utils/update_shields.py

      - name: å¸®åŠ©ä¿¡æ¯
        run: python utils/update_help.py

      - name: ç¿»è¯‘è„šæœ¬è‡ªè¿°
        run: python utils/translate_chinese_to_filelang.py

      - name: è®¾ç½®æœºå™¨äººæäº¤
        run: |
          gpg --batch --import <(echo "${{ secrets.GPG_PRIVATE_KEY }}")
          git config --global commit.gpgsign true
          git config --global user.name 'ChinaGodBot'
          git config --global user.email "${{ secrets.GPG_PRIVATE_EMAIL }}"
          git config --global user.signingkey "${{ secrets.GPG_PRIVATE_ID }}"
      - name: æäº¤å’Œæ¨é€æ›´æ”¹
        run: |
          git pull
          git add .
          COMMIT_MESSAGE="docs(sync): ğŸ¤– åŒæ­¥"

          # docs/[lang]/readme.md
          if git status --short | grep -q "docs/.*/README.md"; then
            if git status --short | grep -q "README_"; then
              COMMIT_MESSAGE+=" [\`docs/[lang]/README.md\`]"
            else
              COMMIT_MESSAGE+=" [\`[lang]/README.md\`]"
            fi
          fi

          # è„šæœ¬è‡ªè¿°
          if git status --short | grep -q "README_"; then
            if git status --short | grep -q "docs/.*/README.md"; then
              COMMIT_MESSAGE+=" [\`[script]/README_[lang].md\`]"
            else
              COMMIT_MESSAGE+=" [\`README_[lang].md\`]"
            fi
          fi

          git commit -n -m "$COMMIT_MESSAGE" || true
          git push
          if [ $? -ne 0 ]; then
            git pull --rebase
            git push
          fi
