// ==UserScript==
// @name              xvideos push download
// @name:ar           XVideos Push Download
// @name:bg           Xvideos Push Download
// @name:cs           XVideos Push Download
// @name:da           XVIDEOS PUSH DOWNLOAD
// @name:de           Xvideos Push -Download
// @name:el           download push xvideos
// @name:en           xvideos push download
// @name:eo           XVideos Push Elŝuti
// @name:es           descarga de push xvideos
// @name:fi           xvideos push lataus
// @name:fr           xvideos push download
// @name:fr-CA        xvideos push download
// @name:he           Xvideos Push Download
// @name:hr           xvideos push preuzimanje
// @name:hu           xvideos push letöltés
// @name:id           Xvideos mendorong unduh
// @name:it           XVIDEOS PUSH Download
// @name:ja           xvideosプッシュダウンロード
// @name:ka           xvideos push ჩამოტვირთვა
// @name:ko           xvideos 푸시 다운로드
// @name:nb           XVIDEOS PUSH Download
// @name:nl           xvideos push download
// @name:pl           XVIDEOS PUSH DOBLOWANIE
// @name:pt-BR        XVIDEOS Push Download
// @name:ro           Descărcarea XVideos Push
// @name:ru           xvideos push скачать
// @name:sk           xvideos push sťahovanie
// @name:sr           квидеос пусх довнлоад
// @name:sv           xvideos push download
// @name:th           ดาวน์โหลด xvideos push
// @name:tr           xvideos push indir
// @name:ug           xvideos ئىتتىرىش
// @name:uk           xvideos push завантажити
// @name:vi           XVIDEOS Đẩy tải xuống
// @name:zh           xvideos推送下载
// @name:zh-CN        xvideos推送下载
// @name:zh-HK        xvideos推送下載
// @name:zh-SG        xvideos推送下载
// @name:zh-TW        xvideos推送下載
// @description:ar    1. التشغيل التلقائي 2. الشاشة العريضة التلقائية 3. التشغيل عالي الجودة 4.
// @description:bg    1. Автоматично възпроизвеждане 2. Автоматичен широкоекранен 3. Висококачествено възпроизвеждане 4. Щракнете, за да натиснете следващия филм 5. Изтеглете миниатюри
// @description:cs    1. automatické přehrávání 2. Automatické širokoúhlé obrazovky 3. vysoce kvalitní přehrávání 4.
// @description:da    1. Automatisk afspilning 2. Automatisk widescreen 3.. Afspilning af høj kvalitet 4. klik for at skubbe den næste film 5. Download miniaturebilleder
// @description:de    1. Automatische Wiedergabe 2. Automatisches Breitbild 3. Hochwertiger Wiedergabe 4. Klicken Sie hier
// @description:el    1. Αυτόματη αναπαραγωγή 2. Αυτόματη ευρεία οθόνη 3. Αναπαραγωγή υψηλής ποιότητας 4. Κάντε κλικ για να πιέσετε την επόμενη ταινία 5. Λήψη μικρογραφιών
// @description:en    1. Automatic playback 2. Automatic widescreen 3. High-quality playback 4. Click to push the next movie 5. Download thumbnails
// @description:eo    1. Aŭtomata reprodukto 2. Aŭtomata larĝekrana 3. Altkvalita reprodukto 4. Alklaku por puŝi la sekvan filmon 5. Elŝuti Miniaturojn
// @description:es    1. Reproducción automática 2. Cerca ancha automática 3. Reproducción de alta calidad 4. Haga clic para presionar la próxima película 5. Descargue las miniaturas
// @description:fi    1. Automaattinen toisto 2. Automaattinen laajakuva 3. Korkealaatuinen toisto 4. Napsauta painaa seuraavaa elokuvaa 5. Lataa pikkukuvat
// @description:fr    1. Playage automatique 2. Écran large automatique 3. Playage de haute qualité 4. Cliquez pour pousser le film suivant 5. Téléchargez les miniatures
// @description:fr-CA 1. Playage automatique 2. Écran large automatique 3. Playage de haute qualité 4. Cliquez pour pousser le film suivant 5. Téléchargez les miniatures
// @description:he    1. הפעלה אוטומטית 2. מסך רחב אוטומטי 3. השמעה באיכות גבוהה 4. לחץ כדי לדחוף את הסרט הבא 5. הורד תמונות ממוזערות
// @description:hr    1. Automatska reprodukcija 2. Automatsko široko zaslon 3. visokokvalitetna reprodukcija 4. Kliknite da biste gurnuli sljedeći film 5. Preuzmite sličice
// @description:hu    1. Automatikus lejátszás 2.
// @description:id    1. Putar Balik Otomatis 2. Otomatis Widescreen 3. Pemutaran Berkualitas Tinggi 4. Klik untuk mendorong film berikutnya 5. Unduh Thumbnails
// @description:it    1. Riproduzione automatica 2. Widescreen automatico 3. Riproduzione di alta qualità 4. Fare clic per spingere il film successivo 5. Scarica le miniature
// @description:ja    1。自動再生2。自動ワイドスクリーン3。高品質の再生4。クリックして次の映画を押してください。
// @description:ka    1. ავტომატური დაკვრა 2. ავტომატური ფართო ეკრანი 3. მაღალი ხარისხის აღწარმოება 4. დააჭირეთ ღილაკს შემდეგი ფილმი 5. ჩამოტვირთეთ მინიატურები
// @description:ko    1. 자동 재생 2. 자동 와이드 스크린 3. 고품질 재생 4. 다음 영화를 푸시하려면 클릭하십시오. 다운로드 썸네일 다운로드
// @description:nb    1.
// @description:nl    1. Automatisch afspelen 2. Automatisch breedbeeld 3. Hoogwaardige afspeel 4. Klik om de volgende film te pushen 5. Download miniatuurs
// @description:pl    1. Automatyczne odtwarzanie 2. Automatyczne panoramiczne 3. Wysokiej jakości odtwarzanie 4. Kliknij, aby popchnąć następny film 5. Pobierz miniatury
// @description:pt-BR 1. Reprodução automática 2. Widescreen automático 3. Reprodução de alta qualidade 4. Clique para empurrar o próximo filme 5. Baixe miniaturas
// @description       1. Automatic playback 2. Automatic widescreen 3. High-quality playback 4. Click to push the next movie 5. Download thumbnails
// @description:ro    1. Redarea automată a 1. automat pe ecran lat. 3. Redarea de înaltă calitate 4. Faceți clic pentru a împinge următorul film 5. Descărcați Miniaturi
// @description:ru    1. Автоматическое воспроизведение 2. Автоматический широкоэкранный 3. Высококачественный воспроизведение 4. Нажмите, чтобы протолкнуть следующий фильм 5. Скачать миниатюры
// @description:sk    1.
// @description:sr    1. Аутоматска репродукција 2. Аутоматски широки екран 3. Клинирајте репродукцију квалитета 4. Кликните да притиснете следећи филм 5. Преузмите сличице
// @description:sv    1. Automatisk uppspelning 2. Automatisk widescreen 3. Högkvalitativ uppspelning 4. Klicka för att trycka på nästa film 5. Ladda ner miniatyrbilder
// @description:th    1. การเล่นอัตโนมัติ 2. ไวด์สกรีนอัตโนมัติ 3. การเล่นคุณภาพสูง 4. คลิกเพื่อส่งภาพยนตร์เรื่องต่อไป 5. ดาวน์โหลดภาพขนาดย่อ
// @description:tr    1. Otomatik Oynatma 2. Otomatik Geniş Ekran 3. Yüksek kaliteli oynatma 4. Bir sonraki filmi itmek için tıklayın 5.
// @description:ug    1. ئاپتوماتىك قويۇش 2. ئاپتوماتىك كەڭ ئېكران 3. يۇقىرى سۈپەتلىك قويۇش 4. كېيىنكى فىلىمنى ئىتتىرىش ئۈچۈن چېكىڭ. كىچىك كۆرۈنۈش
// @description:uk    1. Автоматичне відтворення 2. Автоматичний широкоекранний 3. Високоякісне відтворення 4. Клацніть, щоб натиснути на наступний фільм 5. Завантажте мініатрики
// @description:vi    1. Phát lại tự động 2. Tự động màn hình rộng 3. Phát lại chất lượng cao 4. Nhấp để đẩy bộ phim tiếp theo 5. Tải xuống hình thu nhỏ
// @description:zh    1.自动播放 2.自动宽屏 3.高画质播放 4.点击推送下片 5.下载缩略图
// @description:zh-CN 1.自动播放 2.自动宽屏 3.高画质播放 4.点击推送下片 5.下载缩略图
// @description:zh-HK 1.自動播放 2.自動寬屏 3.高畫質播放 4.點擊推送下片 5.下載縮略圖
// @description:zh-SG 1.自动播放 2.自动宽屏 3.高画质播放 4.点击推送下片 5.下载缩略图
// @description:zh-TW 1.自動播放 2.自動寬屏 3.高畫質播放 4.點擊推送下片 5.下載縮略圖
// @grant             GM_xmlhttpRequest
// @grant             GM_download
// @match             *://*.xvideos.com/video*
// @require           https://update.greasyfork.org/scripts/498897/1404834/Toastnew.js
// @author            cocang,iuroc,人民的勤务员 <china.qinwuyuan@gmail.com>
// @namespace         https://github.com/ChinaGodMan/UserScripts
// @supportURL        https://github.com/ChinaGodMan/UserScripts/issues
// @homepageURL       https://github.com/ChinaGodMan/UserScripts
// @license           MIT
// @icon              https://www.xvideos.com/favicon-32x32.png
// @compatible        chrome
// @compatible        firefox
// @compatible        edge
// @compatible        opera
// @compatible        safari
// @compatible        kiwi
// @version           2025.03.05.0127
// @created           2025-03-05 01:27:35
// @modified          2025-03-05 01:27:35
// ==/UserScript==
//!人民的勤务员修改自以下脚本  感谢 @cocang @iuroc
/* [xvideos 推送下载](https://greasyfork.org/zh-CN/scripts/438212)
  [XVIDEOS M3U8 视频地址获取](https://greasyfork.org/zh-CN/scripts/454287) */
(function () {
    'use strict'
    const userLang = (navigator.languages && navigator.languages[0]) || navigator.language || 'en'
    const translations = {
        'en': {
            downloading: 'Thumbnail is downloading (❛◡❛✿)',
            downloadfailed: 'Thumbnail not found (๑•́ ₃ •̀๑)',
            linkTip: 'M3U8 video link (click to download):',
            previewTip: 'Preview'
        },
        'zh-CN,zh,zh-SG': {
            downloading: '缩略图正在下载  (❛◡❛✿)',
            downloadfailed: '未发现缩略图  (๑•́ ₃ •̀๑)',
            linkTip: 'M3U8视频地址 (点击下载)：',
            previewTip: '预览图'
        },
        'zh-TW,zh-HK,zh-MO': {
            downloading: '縮略圖正在下載  (❛◡❛✿)',
            downloadfailed: '未發現縮略圖  (๑•́ ₃ •̀๑)',
            linkTip: 'M3U8視頻地址 (點擊下載)：',
            previewTip: '預覽圖'
        },
        'ja': {
            downloading: 'サムネイルをダウンロード中 (❛◡❛✿)',
            downloadfailed: 'サムネイルが見つかりませんでした (๑•́ ₃ •̀๑)',
            linkTip: 'M3U8ビデオリンク (クリックしてダウンロード):',
            previewTip: 'プレビュー'
        },
        'vi': {
            downloading: 'Đang tải xuống hình thu nhỏ (❛◡❛✿)',
            downloadfailed: 'Không tìm thấy hình thu nhỏ (๑•́ ₃ •̀๑)',
            linkTip: 'Liên kết video M3U8 (nhấp để tải xuống):',
            previewTip: 'Hình xem trước'
        },
        'fr': {
            downloading: 'Téléchargement de la miniature en cours (❛◡❛✿)',
            downloadfailed: 'Miniature introuvable (๑•́ ₃ •̀๑)',
            linkTip: 'Lien vidéo M3U8 (cliquez pour télécharger):',
            previewTip: 'Aperçu'
        },
        'es': {
            downloading: 'Descargando miniatura (❛◡❛✿)',
            downloadfailed: 'Miniatura no encontrada (๑•́ ₃ •̀๑)',
            linkTip: 'Enlace de video M3U8 (clic para descargar):',
            previewTip: 'Vista previa'
        }
    }
    const getTranslations = (lang) => {
        for (const key in translations) {
            if (key === lang || key.split(',').includes(lang)) {
                return translations[key]
            }
        }
        return translations['en']
    }
    const translate = new Proxy(
        function (key) {
            const lang = userLang
            const strings = getTranslations(lang)
            return strings[key] || translations['en'][key]
        },
        {
            get(target, prop) {
                const lang = userLang
                const strings = getTranslations(lang)
                return strings[prop] || translations['en'][prop]
            }
        }
    )
    //greasyfork.org/scripts/438212
    html5player.player_init && (html5player.toggleExpand())
    const download_btn = document.querySelector('button.dl.tab-button')
    download_btn.insertAdjacentHTML('afterend', '<button class="dl" id="thumbbig"><span class="icon-f icf-image"></span><span>' + translate('previewTip') + '</span></button>')
    document.getElementById('thumbbig').onclick = () => {
        if (html5player.thumb_slide_big) {
            let thumb_url = html5player.thumb_slide_big
            let video_tittle = document.querySelector('p.video-title').innerText
            GM_download(thumb_url, video_tittle + '.jpg')
            Toast(translate('downloading'), 3000, 'rgb(22, 199, 99)', '#ffffff', 'top')
        } else {
            Toast(translate('downloadfailed'), 3000, 'rgb(22, 199, 99)', '#ffffff', 'top')
        }
    }


    Object.defineProperties(html5player.hlsobj, {
        autoLevelEnabled: { value: false, writable: false },
        firstLevel: { value: 4, writable: false }
    })

    let play_val = false
    Object.defineProperty(html5player, 'canPlay', {
        get: () => play_val,
        set: (val) => {
            val && (html5player.playClicked = true)
            val && (html5player.play())
            play_val = val
        }
    })
    var url_hls = html5player.url_hls
    $.get(url_hls, function (data) {
        data = data.split('#EXT-X-STREAM-INF')
        data.splice(0, 1)
        var html = ''
        //排序,从高到低
        data.sort((a, b) => {
            let resolutionA = parseInt(/RESOLUTION=(\d+)x/.exec(a)?.[1] || 0)
            let resolutionB = parseInt(/RESOLUTION=(\d+)x/.exec(b)?.[1] || 0)
            return resolutionB - resolutionA
        })
        data.forEach(item => {
            var name = /NAME="(.*?)"/.exec(item)[1]
            var url = (html5player.url_hls + '#').replace(/hls.m3u8.*#/, /\n(hls-.*)\n?/.exec(item)[1])
            html += `<a style="margin-right: 20px; padding: 5px 10px; border: 1px solid;" href="${url}" class="video-tab" data-url="${url}">${name}</a>`
        })
        $('#video-tabs').append(`<div style="margin-bottom: 10px; margin-top: 10px; font-size: 20px;">${translate('linkTip')}<br>${html}</div>`)
        $('.video-tab').on('click', function (e) {
            // 复制
            e.preventDefault()
            var urlToCopy = $(this).data('url')
            var tempInput = document.createElement('textarea')
            document.body.appendChild(tempInput)
            tempInput.value = urlToCopy
            tempInput.select()
            document.execCommand('copy')
            document.body.removeChild(tempInput)
            // 跳转下载
            let a = document.createElement('a')
            a.href = 'https://tools.thatwind.com/tool/m3u8downloader#m3u8=' + urlToCopy
            a.target = '_blank'
            a.click()
            document.body.removeChild(a)

        })
    })

})()
