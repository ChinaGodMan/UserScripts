// ==UserScript==
// @name         GreasyFork Discussion Watcher
// @name:zh-CN        GreasyFork 通知助手
// @description:zh-CN  当你的脚本或你参与的讨论有新回复时，脚本会在网页上以模态窗口显示最新的讨论内容。
// @name:ar        GreasyFork مساعد الإخطار
// @description:ar  عندما يكون هناك رد جديد على البرنامج النصي الخاص بك أو على مناقشة تشارك فيها，سيعرض البرنامج النصي أحدث محتوى للمناقشة في نافذة مشروطة على صفحة الويب。
// @name:bg        GreasyFork Асистент за уведомяване
// @description:bg  Когато има нов отговор на вашия скрипт или на дискусия, в която участвате，Скриптът ще покаже най-новото съдържание на дискусия в модален прозорец на уеб страницата。
// @name:cs        GreasyFork Asistent upozornění
// @description:cs  Když přijde nová odpověď na váš scénář nebo na diskuzi, které se účastníte，Skript zobrazí nejnovější obsah diskuse v modálním okně na webové stránce。
// @name:da        GreasyFork Underretningsassistent
// @description:da  Når der er et nyt svar på dit manuskript eller til en diskussion, du deltager i，Scriptet vil vise det seneste diskussionsindhold i et modalt vindue på websiden。
// @name:de        GreasyFork Benachrichtigungsassistent
// @description:de  Wenn es eine neue Antwort auf Ihr Skript oder auf eine Diskussion gibt, an der Sie teilnehmen，Das Skript zeigt den neuesten Diskussionsinhalt in einem modalen Fenster auf der Webseite an。
// @name:el        GreasyFork Βοηθός ειδοποιήσεων
// @description:el  Όταν υπάρχει μια νέα απάντηση στο σενάριό σας ή σε μια συζήτηση στην οποία συμμετέχετε，Το σενάριο θα εμφανίσει το πιο πρόσφατο περιεχόμενο συζήτησης σε ένα παράθυρο τρόπου στην ιστοσελίδα。
// @name:en        GreasyFork Notification Assistant
// @description:en  When there’s a new reply to your script or to a discussion you’re participating in，The script will display the latest discussion content in a modal window on the web page。
// @name:eo        GreasyFork Asistanto pri sciigo
// @description:eo  Kiam estas nova respondo al via skripto aŭ al diskuto, kiun vi partoprenas，La skripto montros la lastan diskutenhavon en modala fenestro sur la retpaĝo。
// @name:es        GreasyFork Asistente de notificaciones
// @description:es  Cuando hay una nueva respuesta a tu guión o a una discusión en la que estás participando，El script mostrará el contenido de la discusión más reciente en una ventana modal en la página web.。
// @name:fi        GreasyFork Ilmoitusassistentti
// @description:fi  Kun käsikirjoitukseen tai keskusteluun, johon osallistut, tulee uusi vastaus，Käsikirjoitus näyttää uusimman keskustelusisällön web-sivun modaaliikkunassa。
// @name:fr        GreasyFork Assistant de notifications
// @description:fr  Lorsqu’il y a une nouvelle réponse à votre script ou à une discussion à laquelle vous participez，Le script affichera le dernier contenu de la discussion dans une fenêtre modale sur la page Web。
// @name:he        GreasyFork עוזר הודעות
// @description:he  כאשר יש תשובה חדשה לתסריט שלך או לדיון שאתה משתתף בו，הסקריפט יציג את תוכן הדיון העדכני ביותר בחלון מודאלי בדף האינטרנט。
// @name:hr        GreasyFork Pomoćnik za obavijesti
// @description:hr  Kada postoji novi odgovor na vašu skriptu ili na raspravu u kojoj sudjelujete，Skripta će prikazati najnoviji sadržaj rasprave u modalnom prozoru na web stranici。
// @name:hu        GreasyFork Értesítési asszisztens
// @description:hu  Amikor új válasz érkezik a forgatókönyvére vagy egy beszélgetésre, amelyben részt vesz，A szkript megjeleníti a legfrissebb vitatartalmat egy modális ablakban a weboldalon。
// @name:id        GreasyFork Asisten Pemberitahuan
// @description:id  Ketika ada balasan baru pada naskah Anda atau pada diskusi yang Anda ikuti，Script akan menampilkan konten diskusi terbaru di jendela modal di halaman web。
// @name:it        GreasyFork Assistente alle notifiche
// @description:it  Quando c’è una nuova risposta al tuo script o a una discussione a cui stai partecipando，Lo script visualizzerà il contenuto della discussione più recente in una finestra modale sulla pagina web。
// @name:ja        GreasyFork 通知アシスタント
// @description:ja  スクリプトまたは参加しているディスカッションに対して新しい返信があったとき，スクリプトは、Web ページ上のモーダル ウィンドウに最新のディスカッション コンテンツを表示します。。
// @name:ka        GreasyFork შეტყობინებების ასისტენტი
// @description:ka  როდესაც არის ახალი პასუხი თქვენს სკრიპტზე ან დისკუსიაზე, რომელშიც თქვენ მონაწილეობთ，სკრიპტი აჩვენებს უახლესი დისკუსიის შინაარსს მოდალურ ფანჯარაში ვებ გვერდზე。
// @name:ko        GreasyFork 알림 도우미
// @description:ko  귀하의 스크립트나 귀하가 참여하고 있는 토론에 대한 새로운 답변이 있는 경우，스크립트는 웹 페이지의 모달 창에 최신 토론 내용을 표시합니다.。
// @name:nl        GreasyFork Meldingsassistent
// @description:nl  Wanneer er een nieuw antwoord is op uw script of op een discussie waaraan u deelneemt，Het script geeft de nieuwste discussie-inhoud weer in een modaal venster op de webpagina。
// @name:nb        GreasyFork Varslingsassistent
// @description:nb  Når det kommer et nytt svar på manuset ditt eller på en diskusjon du deltar i，Skriptet vil vise det siste diskusjonsinnholdet i et modalt vindu på nettsiden。
// @name:pl        GreasyFork Asystent powiadomień
// @description:pl  Kiedy pojawi się nowa odpowiedź na Twój skrypt lub dyskusję, w której bierzesz udział，Skrypt wyświetli najnowszą treść dyskusji w oknie modalnym na stronie internetowej。
// @name:pt-BR        GreasyFork Assistente de Notificação
// @description:pt-BR  Quando há uma nova resposta ao seu script ou a uma discussão da qual você está participando，O script exibirá o conteúdo da discussão mais recente em uma janela modal na página da web。
// @name:ro        GreasyFork Asistent de notificare
// @description:ro  Când există un nou răspuns la scenariul dvs. sau la o discuție la care participați，Scriptul va afișa cel mai recent conținut de discuție într-o fereastră modală pe pagina web。
// @name:ru        GreasyFork Помощник по уведомлениям
// @description:ru  Когда появляется новый ответ на ваш сценарий или на обсуждение, в котором вы участвуете.，Скрипт будет отображать последнее содержимое обсуждения в модальном окне на веб-странице.。
// @name:sk        GreasyFork Asistent upozornení
// @description:sk  Keď príde nová odpoveď na váš scenár alebo na diskusiu, ktorej sa zúčastňujete，Skript zobrazí najnovší obsah diskusie v modálnom okne na webovej stránke。
// @name:sr        GreasyFork Помоћник за обавештења
// @description:sr  Када постоји нови одговор на ваш сценарио или на дискусију у којој учествујете，Скрипта ће приказати најновији садржај дискусије у модалном прозору на веб страници。
// @name:sv        GreasyFork Aviseringsassistent
// @description:sv  När det kommer ett nytt svar på ditt manus eller på en diskussion du deltar i，Skriptet kommer att visa det senaste diskussionsinnehållet i ett modalt fönster på webbsidan。
// @name:th        GreasyFork ผู้ช่วยการแจ้งเตือน
// @description:th  เมื่อมีการตอบกลับสคริปต์ของคุณหรือการสนทนาที่คุณเข้าร่วมใหม่，สคริปต์จะแสดงเนื้อหาการสนทนาล่าสุดในหน้าต่างโมดอลบนหน้าเว็บ。
// @name:tr        GreasyFork Bildirim Asistanı
// @description:tr  Senaryonuza veya katıldığınız bir tartışmaya yeni bir yanıt geldiğinde，Komut dosyası, en son tartışma içeriğini web sayfasındaki kalıcı bir pencerede görüntüleyecektir.。
// @name:ug        GreasyFork ئۇقتۇرۇش ياردەمچىسى
// @description:ug  قوليازمىڭىزغا ياكى سىز قاتناشقان مۇنازىرىگە يېڭى جاۋاب كەلگەندە，بۇ قوليازما ئەڭ يېڭى مۇنازىرە مەزمۇنىنى تور بەتتىكى مودېل كۆزنەكتە كۆرسىتىدۇ。
// @name:uk        GreasyFork Помічник сповіщень
// @description:uk  Коли є нова відповідь на ваш сценарій або на обговорення, в якому ви берете участь，Сценарій відображатиме останній вміст обговорення в модальному вікні на веб-сторінці。
// @name:vi        GreasyFork Trợ lý thông báo
// @description:vi  Khi có câu trả lời mới cho tập lệnh của bạn hoặc cho cuộc thảo luận mà bạn đang tham gia，Tập lệnh sẽ hiển thị nội dung thảo luận mới nhất trong một cửa sổ phương thức trên trang web。
// @name:zh-TW        GreasyFork 通知助手
// @description:zh-TW  當你的腳本或你參與的討論有新回應時，腳本會在網頁上以模態視窗顯示最新的討論內容。
// @name:zh-HK        GreasyFork 通知助手
// @description:zh-HK  當你的腳本或你參與的討論有新回應時，腳本會在網頁上以模態視窗顯示最新的討論內容。
// @name:fr-CA        GreasyFork Assistant de notifications
// @description:fr-CA  Lorsqu’il y a une nouvelle réponse à votre script ou à une discussion à laquelle vous participez，Le script affichera le dernier contenu de la discussion dans une fenêtre modale sur la page Web。
// @description  On GreasyFork, when there are new replies to your scripts or discussions you're involved in, the latest discussion content will be displayed on the webpage.
// @namespace    https://github.com/ChinaGodMan/UserScripts
// @version 1.2.0.1
// @icon           https://greasyfork.org/vite/assets/blacklogo96-CxYTSM_T.png
// @author       人民的勤务员 <toniaiwanowskiskr47@gmail.com>
// @match        https://greasyfork.org/*
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_registerMenuCommand
// @supportURL              https://github.com/ChinaGodMan/UserScripts/issues
// @homepageURL   https://github.com/ChinaGodMan/UserScripts
// ==/UserScript==
(function () {
    'use strict'
    const config = {
        isInstalled: GM_getValue('Installed', false),//第一次不加载~,
        lastUpdated: GM_getValue('lastUpdated', 0),//上次更新时间
        delay: GM_getValue('delay', "30m"), // 格式如下: 1h1m1s, 1h1s, 1m, 1s, 1m1s
        userId: null,//当前登录id
        maxItem: GM_getValue('maxItem', "50"),//访问时显示最大的信息数量

    }

    GM_registerMenuCommand("Set refresh time", function () {
        const currentDelay = config.delay
        const newDelay = prompt("New refresh time (example: 1h30m1s, 1s0m30s,1h1s, 1m, 1s):", currentDelay)
        if (newDelay !== null) {
            if (/^\d+(h|m|s)?(\d+(h|m|s)?)*$/.test(newDelay)) {
                GM_setValue('delay', newDelay)
                config.delay = newDelay
            } else {
                alert("The input format is incorrect, please re-enter!")
            }
        }
    })
    GM_registerMenuCommand("Limit message count ", function () {

        const newMax = prompt("New Count:", config.maxItem)
        if (newMax !== null) {
            GM_setValue('maxItem', newMax)
            config.maxItem = newMax
        }
    })
    function timeToSeconds(timeStr) {
        let hours = 0, minutes = 0, seconds = 0
        const hoursMatch = timeStr.match(/(\d+)h/)
        const minutesMatch = timeStr.match(/(\d+)m/)
        const secondsMatch = timeStr.match(/(\d+)s/)
        if (hoursMatch) {
            hours = parseInt(hoursMatch[1], 10)
        }
        if (minutesMatch) {
            minutes = parseInt(minutesMatch[1], 10)
        }
        if (secondsMatch) {
            seconds = parseInt(secondsMatch[1], 10)
        }
        let totalSeconds = (hours * 3600) + (minutes * 60) + seconds
        return totalSeconds
    }
    function isUpdate() {

        const now = Math.floor(new Date().getTime() / 1000)
        const lastUpdated = config.lastUpdated
        const secondsDifference = now - lastUpdated
        if (secondsDifference > timeToSeconds(config.delay)) {
            GM_setValue('lastUpdated', now)
            console.log(`时间超过${config.delay} 进行更新`)
            return true
        }
        return false
    }
    function fetchAndDisplayDiscussions(urls) {
        // GM_setValue('discussions', [])
        if (!isUpdate()) {
            return
        }
        let discussions = GM_getValue('discussions', [])
        let fetchPromises = []
        let itemCount = 0
        var modalHTML = `
            <div id="discussion-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; visibility: hidden;align-items: center; justify-content: center; z-index: 1000;">
                <div id="modal-content" style="background: #fff; border-radius: 10px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); max-height: 80vh; overflow-y: auto; width: 80%; max-width: 600px; padding: 20px; font-family: Arial, sans-serif;">
                    <ul id="discussion-list" style="list-style-type: none; padding: 0; margin: 0;"></ul>
                    <button id="close-button" style="background-color: #ff5e5e; border: none; color: #fff; padding: 5px 10px; cursor: pointer; border-radius: 5px; font-family: Arial, sans-serif; font-size: 14px;">Close</button>
                </div>
            </div>
        `
        document.body.insertAdjacentHTML('beforeend', modalHTML)
        var discussionList = document.getElementById('discussion-list')
        var modalContent = document.getElementById('modal-content')
        urls.forEach(url => {

            fetchPromises.push(
                fetch(url)
                    .then(response => response.text())
                    .then(data => {
                        var parser = new DOMParser()
                        var doc = parser.parseFromString(data, 'text/html')
                        var elements = doc.querySelectorAll('.discussion-list > div > div')
                        elements.forEach(function (element) {
                            var discussionTitle = element.querySelector('.discussion-title')
                            var relativeTimes = element.querySelectorAll('relative-time')
                            if (!discussionTitle || relativeTimes.length === 0) return
                            var discussionTitleHref = discussionTitle.getAttribute('href')
                            var latestRelativeTime = relativeTimes[relativeTimes.length - 1].getAttribute('datetime')
                            var existingDiscussion = discussions.find(function (disc) {
                                return disc.discussionTitleHref === discussionTitleHref
                            })
                            const userLinks = element.querySelectorAll('a.user-link')
                            if (existingDiscussion && existingDiscussion.relativeTime === latestRelativeTime) return
                            var discussionInfo = {
                                discussionTitleHref: discussionTitleHref,
                                relativeTime: latestRelativeTime,
                                lasteduserName: userLinks.length > 1 ? userLinks[userLinks.length - 1].textContent.trim() : null,//最后的发言人
                                lastedID: userLinks.length > 1 ? userLinks[userLinks.length - 1].href.match(/\/users\/(\d+)-/)[1] : null//ANCHOR - 获取最后的发言人ID
                            }
                            if (existingDiscussion) {
                                existingDiscussion.relativeTime = latestRelativeTime
                                existingDiscussion.lasteduserName = discussionInfo.lasteduserName
                            } else {
                                discussions.push(discussionInfo)
                            }
                            if (discussionInfo.lastedID === config.userId) {
                                console.log("skip ")//NOTE - 最新发言是自己,跳过.
                                return
                            }
                            var listItemHTML = '<li class="discussion-item">' + element.innerHTML + '<hr style="margin: 10px 0; border: none; border-top: 1px solid #ddd;"></li>'
                            discussionList.innerHTML += listItemHTML
                            itemCount++
                        })
                    })
            )
        })
        Promise.all(fetchPromises).then(() => {
            if (itemCount === 0) {
                return
            }
            // 将讨论信息保存到 GM_setValue
            GM_setValue('discussions', discussions)
            if (!config.isInstalled) {
                console.log('首次安装时,不弹出:')
                GM_setValue('Installed', true)
                return
            }
            // 计算关闭按钮的位置，并动态设置
            var closeButton = document.getElementById('close-button')
            closeButton.style.position = 'absolute'
            closeButton.style.top = `${discussionList.offsetTop - 50}px`
            closeButton.style.left = `${discussionList.right}px`
            document.getElementById('discussion-modal').style.visibility = 'visible'
            // 设置所有链接在新窗口中打开
            var links = discussionList.querySelectorAll('a')
            links.forEach(function (link) {
                link.setAttribute('target', '_blank')
            })
            // 添加关闭按钮事件
            closeButton.addEventListener('click', function () {
                document.body.removeChild(document.getElementById('discussion-modal'))
            })
        }).catch(error => {
            console.error('无法获取讨论列表:', error)
        })
    }
    function getUserId() {
        const profileLinkElement = document.querySelector("#nav-user-info > span.user-profile-link > a")
        if (profileLinkElement) {
            const href = profileLinkElement.getAttribute('href')
            const match = href.match(/\/users\/(\d+)-/)
            if (match) {
                const userId = match[1]
                console.log(userId)
                return userId
            } else {
                console.log('放弃操作,无法找到id')
                return null
            }
        } else {
            return null
        }
    }
    config.userId = getUserId()
    if (config.userId) {
        fetchAndDisplayDiscussions([
            `https://greasyfork.org/discussions?user=${config.userId}&per_page=${config.maxItem}`,
            `https://greasyfork.org/discussions?me=script&per_page=${config.maxItem}`
        ])
    } else {
        console.log("没有登录,放弃操作")
    }
})()
